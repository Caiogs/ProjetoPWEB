<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto BRL - Gestão de Jornada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // MANTIDAS AS SUAS CHAVES ORIGINAIS
        const FIREBASE_USER_CONFIG = {
            apiKey: "AIzaSyCai6niQ2r0_DuVESfu0fzbTNe6l7NePXk", 
            authDomain: "meu-ponto-app-bada8.firebaseapp.com", 
            projectId: "meu-ponto-app-bada8", 
            storageBucket: "meu-ponto-app-bada8.firebasestorage.app", 
            messagingSenderId: "498041645872",
            appId: "1:498041645872:web:0248fd4c13dcbc8162f6f5" 
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_USER_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const VALOR_HORA_NORMAL = 11.27; 
        const VALOR_HORA_EXTRA = VALOR_HORA_NORMAL * 1.5;
        const JORNADA_DIARIA_MINUTOS = 420; 

        let userId = null;
        let allEntries = [];
        let currentMonthKey = ''; 
        let unsubscribe = null;

        const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

        const tToM = (t) => {
            if (!t || !t.includes(':')) return null;
            const [h, m] = t.split(':').map(Number);
            return (h * 60) + m;
        };

        const mToT = (m) => {
            const absM = Math.abs(m);
            const h = Math.floor(absM / 60);
            const min = Math.floor(absM % 60);
            return `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        };

        const calculateInterval = (start, end) => {
            const mStart = tToM(start);
            const mEnd = tToM(end);
            if (mStart === null || mEnd === null) return 0;
            return mEnd < mStart ? (1440 - mStart) + mEnd : mEnd - mStart;
        };

        const calculateDayStats = (e1, s1, e2, s2) => {
            let totalMin = 0;
            totalMin += calculateInterval(e1, s1);
            totalMin += calculateInterval(e2, s2);
            if (totalMin === 0 && e1 && s2) totalMin = calculateInterval(e1, s2);
            const normalMin = Math.min(totalMin, JORNADA_DIARIA_MINUTOS);
            const extraMin = Math.max(0, totalMin - JORNADA_DIARIA_MINUTOS);
            const ganhoNormal = (normalMin / 60) * VALOR_HORA_NORMAL;
            const ganhoExtra = (extraMin / 60) * VALOR_HORA_EXTRA;
            return { totalMin, normalMin, extraMin, ganhoExtra, ganhoTotal: ganhoNormal + ganhoExtra };
        };

        window.maskTime = (e) => {
            let v = e.target.value.replace(/\D/g, "");
            if (v.length >= 4) {
                v = v.substring(0, 4);
                e.target.value = v.substring(0, 2) + ":" + v.substring(2, 4);
                window.handleInput(e);
            } else { e.target.value = v; }
        };

        setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, async user => {
            const overlay = document.getElementById('loading-overlay');
            if (user) {
                userId = user.uid;
                document.getElementById('user-name').textContent = user.displayName || 'Usuário';
                document.getElementById('user-photo').src = user.photoURL || '';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                if (!currentMonthKey) {
                    const n = new Date();
                    currentMonthKey = `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
                }
                initDataListener();
                setTimeout(() => overlay.classList.add('hidden'), 500);
            } else {
                userId = null;
                if (unsubscribe) unsubscribe();
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                overlay.classList.add('hidden');
            }
        });

        window.loginGoogle = async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try { await signInWithPopup(auth, provider); } 
            catch (error) {
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("Falha no login. Verifique se os pop-ups estão permitidos.");
            }
        };

        function initDataListener() {
            if (unsubscribe) unsubscribe();
            const q = query(collection(db, 'artifacts', appId, 'users', userId, 'registros_horario'));
            unsubscribe = onSnapshot(q, snap => {
                allEntries = [];
                snap.forEach(d => allEntries.push({ ...d.data(), id: d.id }));
                renderMonthTabs();
                renderApp();
            });
        }

        async function saveEntry(date, e1, s1, e2, s2) {
            if(!userId) return;
            const stats = calculateDayStats(e1, s1, e2, s2);
            const docId = date.replace(/-/g, '_');
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'registros_horario', docId), {
                date, entrada1: e1, saida1: s1, entrada2: e2, saida2: s2,
                totalMinutes: stats.totalMin, extraMinutes: stats.extraMin, normalMinutes: stats.normalMin,
                ganhoDiario: stats.ganhoTotal, ganhoExtraDiario: stats.ganhoExtra,
                updatedAt: Timestamp.now()
            }, { merge: true });
        }

        window.handleInput = (e) => {
            const row = e.target.closest('tr');
            const d = row.querySelector('[name=date]').value;
            const e1 = row.querySelector('[name=e1]').value, s1 = row.querySelector('[name=s1]').value;
            const e2 = row.querySelector('[name=e2]').value, s2 = row.querySelector('[name=s2]').value;
            if(d) saveEntry(d, e1, s1, e2, s2);
        };

        window.addNewRow = () => {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;
            currentMonthKey = `${y}-${m}`;
            saveEntry(todayStr, '08:00', '12:00', '13:00', '16:00');
        };

        window.switchTab = (key) => {
            currentMonthKey = key;
            renderMonthTabs();
            renderApp();
        };

        function renderMonthTabs() {
            const tabsContainer = document.getElementById('month-tabs');
            const monthsFound = [...new Set(allEntries.map(e => e.date.substring(0, 7)))];
            const now = new Date();
            const nowKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            if (!monthsFound.includes(nowKey)) monthsFound.push(nowKey);

            monthsFound.sort().reverse();
            tabsContainer.innerHTML = monthsFound.map(key => {
                const [year, month] = key.split('-');
                const name = new Date(year, month - 1).toLocaleString('pt-BR', { month: 'short' });
                const active = currentMonthKey === key 
                    ? 'bg-indigo-600 text-white shadow-[0_10px_20px_-5px_rgba(79,70,229,0.4)]' 
                    : 'bg-white/80 text-stone-500 border border-stone-200/50 hover:bg-white';
                return `<button onclick="window.switchTab('${key}')" class="px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-tighter transition-all whitespace-nowrap ${active}">${name} ${year}</button>`;
            }).join('');
        }

        function renderApp() {
            const tbody = document.getElementById('table-body');
            const filtered = allEntries.filter(e => e.date.startsWith(currentMonthKey));
            tbody.innerHTML = '';
            
            let tNormalMin = 0, tExtraMin = 0, tGanhoExtras = 0, tGanhoGeral = 0;

            filtered.sort((a,b) => b.date.localeCompare(a.date)).forEach(d => {
                const s = calculateDayStats(d.entrada1, d.saida1, d.entrada2, d.saida2);
                tNormalMin += s.normalMin; tExtraMin += s.extraMin; 
                tGanhoExtras += s.ganhoExtra; tGanhoGeral += s.ganhoTotal;

                const tr = document.createElement('tr');
                tr.className = "border-b border-stone-100/50 hover:bg-indigo-50/30 group transition-colors";
                tr.innerHTML = `
                    <td class="p-4"><input type="date" name="date" value="${d.date}" onchange="window.handleInput(event)" class="bg-transparent outline-none font-bold text-stone-700 text-xs"></td>
                    <td class="p-4 text-center"><input type="text" maxlength="5" name="e1" value="${d.entrada1||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200/60 rounded-xl py-2 text-xs font-semibold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                    <td class="p-4 text-center"><input type="text" maxlength="5" name="s1" value="${d.saida1||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200/60 rounded-xl py-2 text-xs font-semibold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                    <td class="p-4 text-center"><input type="text" maxlength="5" name="e2" value="${d.entrada2||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200/60 rounded-xl py-2 text-xs font-semibold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                    <td class="p-4 text-center"><input type="text" maxlength="5" name="s2" value="${d.saida2||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200/60 rounded-xl py-2 text-xs font-semibold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                    <td class="p-4 text-center font-bold text-stone-400 text-[10px]">${mToT(s.totalMin)}</td>
                    <td class="p-4 text-center font-black text-amber-600 text-[10px]">${mToT(s.extraMin)}</td>
                    <td class="p-4 text-right font-black text-amber-700 text-[11px]">${formatBRL(s.ganhoExtra)}</td>
                    <td class="p-4 text-right font-black text-indigo-900 text-[11px]">${formatBRL(s.ganhoTotal)}</td>
                    <td class="p-4 text-center"><button onclick="window.deletarRegistro('${d.id}')" class="opacity-0 group-hover:opacity-100 text-stone-300 hover:text-red-500 transition-all">✕</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('total-horas-normais').textContent = mToT(tNormalMin);
            document.getElementById('total-horas-extras').textContent = mToT(tExtraMin);
            document.getElementById('ganho-extras-top').textContent = formatBRL(tGanhoExtras);
            document.getElementById('salario-final').textContent = formatBRL(tGanhoGeral);
        }

        window.deletarRegistro = async (id) => {
            if(confirm("Apagar registro?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'registros_horario', id));
        };
        
        window.handleLogout = async () => {
            if(confirm("Deseja sair?")) await signOut(auth);
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .bg-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }
    </style>
</head>
<body class="bg-pattern text-stone-800 min-h-screen">
    
    <!-- Overlay de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-[3px] border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-black text-indigo-950 text-[10px] tracking-[0.2em] uppercase italic">Sincronizando Nuvem</p>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="hidden flex flex-col items-center justify-center min-h-screen p-6 relative">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-indigo-200/20 blur-[120px] rounded-full -z-10"></div>
        <div class="bg-white/90 backdrop-blur-xl p-12 rounded-[3.5rem] shadow-[0_32px_64px_-16px_rgba(0,0,0,0.1)] text-center max-w-sm w-full border border-white">
            <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 shadow-[0_20px_40px_-10px_rgba(79,70,229,0.5)] rotate-6">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </div>
            <h1 class="font-black text-5xl tracking-tighter text-indigo-950 italic mb-3">PONTO.BRL</h1>
            <p class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.3em] mb-12">Profissional Cloud</p>
            
            <button onclick="window.loginGoogle()" class="w-full flex items-center justify-center gap-4 bg-white border border-stone-100 text-stone-700 font-bold py-5 px-6 rounded-[2rem] hover:shadow-2xl hover:-translate-y-1 transition-all active:scale-95 group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition-transform">
                Acessar com Google
            </button>
            <p class="mt-10 text-[10px] text-stone-400 font-semibold px-6 leading-relaxed">Seus dados são criptografados e vinculados à sua conta pessoal Google.</p>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app-screen" class="hidden max-w-6xl mx-auto py-10 px-6">
        <header class="flex justify-between items-center mb-12 bg-white/60 backdrop-blur-md p-6 rounded-[2.5rem] border border-white/40 shadow-sm">
            <div class="flex items-center gap-5">
                <div class="relative">
                    <img id="user-photo" src="" class="w-16 h-16 rounded-[1.5rem] border-4 border-white shadow-md object-cover">
                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 border-4 border-white rounded-full"></div>
                </div>
                <div>
                    <h2 id="user-name" class="font-black text-indigo-950 tracking-tight text-2xl leading-none mb-1">...</h2>
                    <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">Painel de Controle</p>
                </div>
            </div>
            <button onclick="window.handleLogout()" class="text-[10px] font-black text-red-500 bg-red-50 px-6 py-3.5 rounded-2xl hover:bg-red-100 transition-all tracking-widest">SAIR</button>
        </header>

        <nav id="month-tabs" class="flex gap-3 mb-10 overflow-x-auto no-scrollbar py-2"></nav>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="glass-card p-8 rounded-[3rem] shadow-sm">
                <p class="text-[9px] font-black text-stone-400 uppercase tracking-widest mb-3">Horas Normais</p>
                <p id="total-horas-normais" class="text-4xl font-black text-indigo-600 tracking-tighter">00:00</p>
            </div>
            <div class="glass-card p-8 rounded-[3rem] shadow-sm">
                <p class="text-[9px] font-black text-amber-500 uppercase tracking-widest mb-3">Horas Extras</p>
                <p id="total-horas-extras" class="text-4xl font-black text-amber-600 tracking-tighter">00:00</p>
            </div>
            <div class="glass-card p-8 rounded-[3rem] shadow-sm">
                <p class="text-[9px] font-black text-amber-500 uppercase tracking-widest mb-3">Ganhos Extras</p>
                <p id="ganho-extras-top" class="text-4xl font-black text-amber-700 tracking-tighter">R$ 0,00</p>
            </div>
            <div class="bg-indigo-950 p-8 rounded-[3rem] shadow-2xl ring-8 ring-indigo-50/50">
                <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-3 text-center">Salário Bruto</p>
                <p id="salario-final" class="text-4xl font-black text-white tracking-tighter text-center">R$ 0,00</p>
            </div>
        </div>

        <div class="bg-white/70 backdrop-blur-xl rounded-[3.5rem] border border-white shadow-2xl shadow-indigo-100/50 overflow-hidden mb-16">
            <div class="p-10 border-b border-stone-100/50 flex justify-between items-center bg-white/40">
                <div>
                    <h2 class="font-black text-indigo-950 text-2xl tracking-tight mb-1">Folha de Frequência</h2>
                    <p class="text-[10px] text-stone-400 font-bold uppercase tracking-[0.2em]">Cálculo em tempo real</p>
                </div>
                <button onclick="window.addNewRow()" class="bg-indigo-600 text-white px-10 py-4 rounded-[1.8rem] text-xs font-black shadow-[0_15px_30px_-10px_rgba(79,70,229,0.5)] hover:bg-indigo-700 active:scale-95 transition-all">+ NOVO REGISTRO</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm min-w-[1000px]">
                    <thead class="bg-stone-50/40 border-b border-stone-100/50 text-stone-400 font-black text-[9px] uppercase tracking-widest">
                        <tr>
                            <th class="p-8">Data</th>
                            <th class="p-8 text-center">Ent. 1</th><th class="p-8 text-center">Saí. 1</th>
                            <th class="p-8 text-center">Ent. 2</th><th class="p-8 text-center">Saí. 2</th>
                            <th class="p-8 text-center">Total</th><th class="p-8 text-center text-amber-600">Extra</th>
                            <th class="p-8 text-right">R$ Extra</th><th class="p-8 text-right text-indigo-950 font-black">R$ Total</th>
                            <th class="p-8"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>