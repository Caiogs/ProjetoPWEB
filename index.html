<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PONTO.BRL - Gestão Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Suas chaves originais mantidas estritamente
        const firebaseConfig = {
            apiKey: "AIzaSyCai6niQ2r0_DuVESfu0fzbTNe6l7NePXk", 
            authDomain: "meu-ponto-app-bada8.firebaseapp.com", 
            projectId: "meu-ponto-app-bada8", 
            storageBucket: "meu-ponto-app-bada8.firebasestorage.app", 
            messagingSenderId: "498041645872",
            appId: "1:498041645872:web:0248fd4c13dcbc8162f6f5" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        // Regras de Negócio
        const VALOR_HORA_NORMAL = 11.27; 
        const VALOR_HORA_EXTRA = VALOR_HORA_NORMAL * 1.5;
        const JORNADA_DIARIA_MIN = 420; 

        let allEntries = [];
        let currentMonthKey = ''; 
        let unsubscribe = null;

        const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
        const tToM = (t) => { if (!t || !t.includes(':')) return null; const [h, m] = t.split(':').map(Number); return (h * 60) + m; };
        const mToT = (m) => { const h = Math.floor(Math.abs(m) / 60); const min = Math.floor(Math.abs(m) % 60); return `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`; };

        const calculateStats = (e1, s1, e2, s2) => {
            const diff = (start, end) => {
                const mS = tToM(start), mE = tToM(end);
                if (mS === null || mE === null) return 0;
                return mE < mS ? (1440 - mS) + mE : mE - mS;
            };
            let total = diff(e1, s1) + diff(e2, s2);
            if (total === 0 && e1 && s2) total = diff(e1, s2);
            const normal = Math.min(total, JORNADA_DIARIA_MIN);
            const extra = Math.max(0, total - JORNADA_DIARIA_MIN);
            return { total, normal, extra, valTotal: ((normal/60)*VALOR_HORA_NORMAL) + ((extra/60)*VALOR_HORA_EXTRA) };
        };

        // Escuta em Tempo Real (Apenas após Auth)
        const startSync = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registros_horario'));
            if (unsubscribe) unsubscribe();
            
            unsubscribe = onSnapshot(q, (snap) => {
                allEntries = [];
                snap.forEach(d => allEntries.push({ ...d.data(), id: d.id }));
                if (!currentMonthKey) {
                    const now = new Date();
                    currentMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                }
                render();
                document.getElementById('boot-loader').classList.add('opacity-0', 'pointer-events-none');
            }, (err) => console.error("Erro Firestore:", err));
        };

        // Login Anônimo para liberar o carregamento
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                startSync();
            } else {
                try { await signInAnonymously(auth); } 
                catch (e) { console.error("Erro Auth:", e); }
            }
        });

        window.saveRow = async (id, data) => {
            const stats = calculateStats(data.entrada1, data.saida1, data.entrada2, data.saida2);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registros_horario', id), {
                ...data,
                totalMinutes: stats.total,
                extraMinutes: stats.extra,
                valTotal: stats.valTotal,
                updatedAt: Timestamp.now()
            }, { merge: true });
        };

        window.handleInput = (e) => {
            const row = e.target.closest('tr');
            const id = row.dataset.id;
            window.saveRow(id, {
                date: row.querySelector('[name=date]').value,
                entrada1: row.querySelector('[name=e1]').value,
                saida1: row.querySelector('[name=s1]').value,
                entrada2: row.querySelector('[name=e2]').value,
                saida2: row.querySelector('[name=s2]').value
            });
        };

        window.maskTime = (e) => {
            let v = e.target.value.replace(/\D/g, "");
            if (v.length >= 4) {
                v = v.substring(0, 4);
                e.target.value = v.substring(0, 2) + ":" + v.substring(2, 4);
                window.handleInput(e);
            } else { e.target.value = v; }
        };

        window.addRow = async () => {
            const date = new Date().toISOString().split('T')[0];
            const id = date.replace(/-/g, '_') + '_' + Date.now();
            await window.saveRow(id, { date, entrada1: '08:00', saida1: '12:00', entrada2: '13:00', saida2: '16:00' });
        };

        window.delRow = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registros_horario', id)); };
        window.setMonth = (k) => { currentMonthKey = k; render(); };

        function render() {
            const tabs = document.getElementById('month-tabs');
            const tbody = document.getElementById('table-body');
            
            const months = [...new Set(allEntries.map(e => e.date.substring(0, 7)))];
            const nowK = new Date().toISOString().substring(0, 7);
            if (!months.includes(nowK)) months.push(nowK);
            months.sort().reverse();

            tabs.innerHTML = months.map(m => {
                const [y, mm] = m.split('-');
                const label = new Date(y, mm-1).toLocaleString('pt-BR', { month: 'short', year: '2-digit' }).toUpperCase();
                const active = currentMonthKey === m ? 'bg-indigo-600 text-white shadow-xl scale-105' : 'bg-white/80 text-stone-400 border border-stone-100 hover:bg-white';
                return `<button onclick="window.setMonth('${m}')" class="px-6 py-3 rounded-2xl text-[10px] font-black transition-all ${active}">${label}</button>`;
            }).join('');

            const filtered = allEntries.filter(e => e.date.startsWith(currentMonthKey));
            tbody.innerHTML = '';
            let sN=0, sE=0, sV=0;

            filtered.sort((a,b) => b.date.localeCompare(a.date)).forEach(d => {
                const s = calculateStats(d.entrada1, d.saida1, d.entrada2, d.saida2);
                sN += Math.min(s.total, JORNADA_DIARIA_MIN); sE += s.extra; sV += s.valTotal;

                tbody.innerHTML += `
                    <tr class="border-b border-stone-100/60 group hover:bg-indigo-50/30 transition-all" data-id="${d.id}">
                        <td class="p-6"><input type="date" name="date" value="${d.date}" onchange="window.handleInput(event)" class="bg-transparent font-bold text-stone-700 text-xs outline-none"></td>
                        <td class="p-6 text-center"><input type="text" name="e1" value="${d.entrada1||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200 rounded-xl py-2 text-xs font-bold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                        <td class="p-6 text-center"><input type="text" name="s1" value="${d.saida1||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200 rounded-xl py-2 text-xs font-bold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                        <td class="p-6 text-center"><input type="text" name="e2" value="${d.entrada2||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200 rounded-xl py-2 text-xs font-bold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                        <td class="p-6 text-center"><input type="text" name="s2" value="${d.saida2||''}" oninput="window.maskTime(event)" class="w-20 text-center bg-white border border-stone-200 rounded-xl py-2 text-xs font-bold shadow-sm outline-none focus:ring-2 focus:ring-indigo-500/20"></td>
                        <td class="p-6 text-center font-bold text-stone-400 text-[10px]">${mToT(s.total)}</td>
                        <td class="p-6 text-center font-black text-amber-600 text-[10px]">${mToT(s.extra)}</td>
                        <td class="p-6 text-right font-black text-indigo-950 text-[11px]">${formatBRL(s.valTotal)}</td>
                        <td class="p-6 text-center"><button onclick="window.delRow('${d.id}')" class="opacity-0 group-hover:opacity-100 text-stone-300 hover:text-red-500 transition-all">✕</button></td>
                    </tr>`;
            });
            document.getElementById('cN').textContent = mToT(sN);
            document.getElementById('cE').textContent = mToT(sE);
            document.getElementById('cV').textContent = formatBRL(sV);
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; background-image: radial-gradient(#e2e8f0 0.8px, transparent 0.8px); background-size: 32px 32px; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255, 255, 255, 0.4); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen text-stone-800 antialiased">

    <div id="boot-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black tracking-[0.3em] uppercase text-stone-400 italic">Sincronizando Cloud...</p>
    </div>

    <div class="max-w-6xl mx-auto py-12 px-6">
        <header class="flex justify-between items-center mb-12 glass p-7 rounded-[2.5rem] shadow-2xl shadow-indigo-100/20">
            <div class="flex items-center gap-6">
                <div class="w-16 h-16 bg-indigo-600 rounded-[1.8rem] flex items-center justify-center shadow-[0_15px_40px_-10px_rgba(79,70,229,0.5)] rotate-3">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2.5" stroke-linecap="round"></path></svg>
                </div>
                <div>
                    <h1 class="font-black text-indigo-950 text-2xl italic tracking-tighter">PONTO.BRL <span class="text-indigo-500 font-normal italic">PRO</span></h1>
                    <p class="text-[9px] font-black text-stone-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Sistema Seguro
                    </p>
                </div>
            </div>
            <button onclick="window.addRow()" class="bg-indigo-600 text-white px-10 py-4 rounded-[1.5rem] text-xs font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 hover:-translate-y-1 transition-all active:scale-95">NOVO REGISTRO</button>
        </header>

        <nav id="month-tabs" class="flex gap-4 mb-10 overflow-x-auto no-scrollbar py-2"></nav>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-14">
            <div class="glass p-8 rounded-[3rem] shadow-sm">
                <p class="text-[9px] font-black text-stone-400 uppercase tracking-widest mb-3">Horas Normais</p>
                <p id="cN" class="text-4xl font-black text-indigo-600 tracking-tighter">00:00</p>
            </div>
            <div class="glass p-8 rounded-[3rem] shadow-sm border-l-4 border-amber-400">
                <p class="text-[9px] font-black text-amber-500 uppercase tracking-widest mb-3">Horas Extras</p>
                <p id="cE" class="text-4xl font-black text-amber-600 tracking-tighter">00:00</p>
            </div>
            <div class="bg-indigo-950 p-8 rounded-[3rem] shadow-2xl ring-8 ring-indigo-50/50">
                <p class="text-[9px] font-black text-indigo-300 uppercase tracking-widest mb-3 text-center">Salário Bruto</p>
                <p id="cV" class="text-4xl font-black text-white tracking-tighter text-center">R$ 0,00</p>
            </div>
        </div>

        <div class="glass rounded-[3.5rem] overflow-hidden shadow-2xl shadow-indigo-100/30 border border-white">
            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[950px]">
                    <thead class="bg-stone-50/40 border-b border-stone-100/50 text-[9px] font-black text-stone-400 uppercase tracking-widest">
                        <tr>
                            <th class="p-8">Data</th>
                            <th class="p-8 text-center">E1</th><th class="p-8 text-center">S1</th>
                            <th class="p-8 text-center">E2</th><th class="p-8 text-center">S2</th>
                            <th class="p-8 text-center">Total</th><th class="p-8 text-center text-amber-600">Extra</th>
                            <th class="p-8 text-right text-indigo-950 font-black">Valor Total</th>
                            <th class="p-8"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            <div class="p-8 bg-stone-50/30 text-center">
                <p class="text-[10px] font-bold text-stone-300 uppercase tracking-[0.4em]">Sincronização Cloud via Firebase Auth</p>
            </div>
        </div>
    </div>
</body>
</html>

